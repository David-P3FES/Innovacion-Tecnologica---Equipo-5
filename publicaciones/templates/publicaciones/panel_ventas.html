{% extends "base.html" %}
{% load static %}
{% load humanize %}
{% block extra_css %}
<link rel="stylesheet" href="{% static 'panel.css' %}?v=6">

<style>
:root { --avatar-scale: 1.15; } 
.header .navbar-actions .trigger-wrap{
  gap: 0 !important;
}
.header .navbar-actions .caret-btn{
  margin-left: 0 !important;
  transform: translateX(-1px);
}

.header .navbar-actions .avatar-circle{
  width: 30px;
  height: 30px;
  border: 2px solid rgba(255,255,255,.7) !important;
  box-shadow: 0 4px 10px rgba(0,0,0,.25) !important;
  background:
    radial-gradient(circle at 30% 30%, rgba(255,255,255,.35), transparent 60%),
    var(--primary-gradient) !important;
  transform: scale(var(--avatar-scale));
  transform-origin: center;
  margin-right: -4px !important;
}

.header .navbar-actions .avatar-circle::after{
  font-size: 14px !important;
  transform: scale(calc(1 / var(--avatar-scale))) translateY(3px);
  transform-origin: center;
}
</style>
{% endblock %}



{% block content %}
<div class="panel-wrap">
  <div class="panel-head">
    <h1>Mis publicaciones</h1>
    <div class="actions-inline">
      <a href="{% url 'publicaciones:crear' %}"
         class="btn btn-primary"
         id="btn-create"
         data-is-subscribed="{% if user.perfil.is_subscribed %}1{% else %}0{% endif %}"
         data-trial-ended="{% if user.perfil.trial_ended %}1{% else %}0{% endif %}">
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M12 5v14M5 12h14"/></svg>
        Nueva publicación
      </a>
    </div>
  </div>

  <div class="stats">
    <div class="stat">
      <div class="stat-value">{{ stats.total|default:0 }}</div>
      <div class="stat-label">Publicadas</div>
    </div>
    <div class="stat stat-ok">
      <div class="stat-value">{{ stats.disponibles|default:0 }}</div>
      <div class="stat-label">Disponibles</div>
    </div>
    <div class="stat stat-warn">
      <div class="stat-value">{{ stats.en_trato|default:0 }}</div>
      <div class="stat-label">En trato</div>
    </div>
    <div class="stat stat-bad">
      <div class="stat-value">{{ stats.cerradas|default:0 }}</div>
      <div class="stat-label">Vendidas/Rentadas</div>
    </div>
  </div>

  <form method="get" class="filters">
    <select name="operacion" class="input-select">
      <option value="">Operación (todas)</option>
      <option value="venta" {% if operacion_sel == 'venta' %}selected{% endif %}>Venta</option>
      <option value="renta" {% if operacion_sel == 'renta' %}selected{% endif %}>Renta</option>
    </select>
    <select name="estatus" class="input-select">
      <option value="">Estatus (todos)</option>
      <option value="disponible" {% if estatus_sel == 'disponible' %}selected{% endif %}>Disponible</option>
      <option value="en_trato" {% if estatus_sel == 'en_trato' %}selected{% endif %}>En trato</option>
      <option value="cerrada" {% if estatus_sel == 'cerrada' %}selected{% endif %}>Vendida/Rentada</option>
    </select>
    <button type="submit" class="btn btn-filter">Filtrar</button>
    <a href="{% url 'publicaciones:panel' %}" class="btn btn-light">Limpiar</a>
  </form>

  {% if page_obj.object_list %}
    <div class="publications-grid">
      {% for pub in page_obj.object_list %}
      <article class="pub-card">
        <div class="pub-image">
          {% with portada=pub.foto_portada %}
            {% if portada %}
              <img src="{{ portada.imagen.url }}" alt="{{ pub.titulo }}">
            {% else %}
              <div class="no-image">Sin foto</div>
            {% endif %}
          {% endwith %}
          <span class="badge badge-status badge-{{ pub.estatus }}">{{ pub.get_estatus_display }}</span>
        </div>

        <div class="pub-body">
          <h3 class="pub-title">{{ pub.titulo }}</h3>
          <div class="pub-price">${{ pub.precio|floatformat:0|intcomma }}</div>
          <div class="pub-location">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor"><path d="M12 2C8.13 2 5 5.13 5 9c0 5.25 7 13 7 13s7-7.75 7-13c0-3.87-3.13-7-7-7zm0 9.5a2.5 2.5 0 110-5 2.5 2.5 0 010 5z"/></svg>
            {{ pub.direccion_completa }}
          </div>
          <div class="pub-features">
            {% if pub.recamaras %}
              <span class="feat">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <path d="M3 10h18M4 10V7a3 3 0 013-3h10a3 3 0 013 3v3M6 21v-6a2 2 0 012-2h8a2 2 0 012 2v6M3 21h18"/>
                </svg>
                {{ pub.recamaras }} hab
              </span>
            {% endif %}

            {% if pub.banos %}
              <span class="feat">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <path d="M7 10V5a3 3 0 016 0v5M3 14h18M5 14v2a5 5 0 005 5h4a5 5 0 005-5v-2"/>
                </svg>
                {{ pub.banos }} baños
              </span>
            {% endif %}

            {% if pub.estacionamientos %}
              <span class="feat">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <path d="M3 13l2-5h14l2 5M5 13v6m14-6v6M8 19h8"/>
                </svg>
                {{ pub.estacionamientos }} estac.
              </span>
            {% endif %}

            {% if pub.m2_construccion %}
              <span class="feat">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <path d="M3 3h18v18H3z"/><path d="M3 9h18M9 21V9"/>
                </svg>
                {{ pub.m2_construccion|floatformat:0 }} m² const.
              </span>
            {% endif %}

            {% if pub.m2_terreno %}
              <span class="feat">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <rect x="3" y="7" width="18" height="10" rx="2"/><path d="M7 7v10M17 7v10"/>
                </svg>
                {{ pub.m2_terreno|floatformat:0 }} m² terreno
              </span>
            {% endif %}
          </div>

        </div>

        <div class="pub-actions">
          <form class="status-form" action="{% url 'publicaciones:cambiar_estatus' pub.pk %}" method="post" {% if not user.perfil.is_subscribed %}onsubmit="return showSubscriptionModal(event)"{% endif %}>
            {% csrf_token %}
            <select name="estatus" class="status-select" onchange="this.form.submit()" {% if not user.perfil.is_subscribed %}disabled{% endif %}>
              <option value="disponible" {% if pub.estatus == 'disponible' %}selected{% endif %}>Disponible</option>
              <option value="en_trato" {% if pub.estatus == 'en_trato' %}selected{% endif %}>En trato</option>
              <option value="cerrada" {% if pub.estatus == 'cerrada' %}selected{% endif %}>Vendida/Rentada</option>
            </select>
          </form>

          <div class="action-buttons">
            {% if user.perfil.is_subscribed %}
            <a href="{% url 'publicaciones:editar' pub.pk %}" class="btn-icon btn-edit" aria-label="Editar">
              <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M11 4H4a2 2 0 00-2 2v14a2 2 0 002 2h14a2 2 0 002-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 013 3L12 15l-4 1 1-4 9.5-9.5z"/></svg>
            </a>
            <form action="{% url 'publicaciones:eliminar' pub.pk %}" method="post" style="display:inline;" onsubmit="return confirm('¿Eliminar «{{ pub.titulo|escapejs }}»?');">
              {% csrf_token %}
              <button type="submit" class="btn-icon btn-delete" aria-label="Eliminar">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 6h18M19 6v14a2 2 0 01-2 2H7a2 2 0 01-2-2V6m3 0V4a2 2 0 012-2h4a2 2 0 012 2v2"/></svg>
              </button>
            </form>
            {% else %}
            <button class="btn-icon btn-edit btn-locked" onclick="showSubscriptionModal(event)" aria-label="Editar (requiere suscripción)">
              <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="11" width="18" height="11" rx="2" ry="2"/><path d="M7 11V7a5 5 0 0110 0v4"/></svg>
            </button>
            {% endif %}
          </div>
        </div>
      </article>
      {% endfor %}
    </div>

    <div class="pagination">
      {% if page_obj.has_previous %}
        <a class="page-btn" href="?page={{ page_obj.previous_page_number }}{% if estatus_sel %}&estatus={{ estatus_sel }}{% endif %}{% if operacion_sel %}&operacion={{ operacion_sel }}{% endif %}">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M15 18l-6-6 6-6"/></svg>
          Anterior
        </a>
      {% endif %}
      <span class="page-current">Página {{ page_obj.number }} de {{ page_obj.paginator.num_pages }}</span>
      {% if page_obj.has_next %}
        <a class="page-btn" href="?page={{ page_obj.next_page_number }}{% if estatus_sel %}&estatus={{ estatus_sel }}{% endif %}{% if operacion_sel %}&operacion={{ operacion_sel }}{% endif %}">
          Siguiente
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M9 18l6-6-6-6"/></svg>
        </a>
      {% endif %}
    </div>
  {% else %}
    <div class="empty-state">
      <svg width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"/><line x1="9" y1="9" x2="15" y2="9"/><line x1="9" y1="15" x2="15" y2="15"/></svg>
      <h3>No tienes publicaciones todavía</h3>
      <p>Comienza creando tu primera publicación</p>
    </div>
  {% endif %}
</div>

<div id="plans-overlay" class="plans-overlay" aria-hidden="true">
  <div class="plans-dialog" role="dialog" aria-modal="true" aria-labelledby="plans-title">
    <button type="button" class="plans-close" id="plans-close" aria-label="Cerrar">&times;</button>
    <header class="plans-header">
      <div class="plans-icon">
        <svg width="40" height="40" viewBox="0 0 24 24" fill="currentColor"><path d="M3 10.5L12 3l9 7.5V21a1 1 0 0 1-1 1h-5v-6H9v6H4a1 1 0 0 1-1-1v-10.5z"/></svg>
      </div>
      <div>
        <h2 id="plans-title" class="plans-title">Tu prueba terminó</h2>
        <p class="plans-subtitle">Activa o renueva tu plan para crear y editar publicaciones.</p>
      </div>
    </header>
    <div class="plans-grid">
      <article class="plan-card basic">
        <div class="plan-header">
          <h3>Semanal</h3>
          <div class="plan-badge">Básico</div>
        </div>
        <div class="price">$49<span>MXN</span></div>
        <p class="plan-desc">Perfecto para empezar</p>
        <ul>
          <li>✓ Publicaciones ilimitadas</li>
          <li>✓ Visibilidad estándar</li>
          <li>✓ Soporte básico</li>
        </ul>
        <button class="btn-plan-choose" data-plan="weekly">Elegir semanal</button>
      </article>
      <article class="plan-card pro">
        <div class="plan-popular">Más popular</div>
        <div class="plan-header">
          <h3>Mensual</h3>
          <div class="plan-badge">Profesional</div>
        </div>
        <div class="price">$199<span>MXN</span></div>
        <p class="plan-desc">La mejor opción calidad-precio</p>
        <ul>
          <li>✓ Publicaciones ilimitadas</li>
          <li>✓ Destacar propiedades</li>
          <li>✓ Soporte prioritario</li>
          <li>✓ Estadísticas avanzadas</li>
        </ul>
        <button class="btn-plan-choose" data-plan="monthly">Elegir mensual</button>
      </article>
      <article class="plan-card premium">
        <div class="plan-header">
          <h3>Anual</h3>
          <div class="plan-badge">Premium</div>
        </div>
        <div class="price">$1,799<span>MXN</span></div>
        <p class="plan-desc">Máximo ahorro y beneficios</p>
        <ul>
          <li>✓ Publicaciones ilimitadas</li>
          <li>✓ Prioridad máxima</li>
          <li>✓ Reportes de rendimiento</li>
          <li>✓ Soporte VIP 24/7</li>
          <li>✓ Ahorra 2 meses</li>
        </ul>
        <button class="btn-plan-choose" data-plan="yearly">Elegir anual</button>
      </article>
    </div>
    <footer class="plans-footer">
      <small>Los precios incluyen IVA. Puedes cancelar cuando quieras sin compromiso.</small>
    </footer>
  </div>
</div>
{% endblock %}
{% block extra_js %}
{{ block.super }}
<script>
(function(){
  function getCookie(name){const value=`; ${document.cookie}`;const parts=value.split(`; ${name}=`);if(parts.length===2)return parts.pop().split(';').shift();}
  const csrftoken=getCookie('csrftoken');
  const btnCreate=document.getElementById('btn-create');
  const overlay=document.getElementById('plans-overlay');
  const closeBtn=document.getElementById('plans-close');
  let __lockScrollY=0;
  function openPlans(){
    __lockScrollY=window.scrollY||document.documentElement.scrollTop;
    document.body.style.position='fixed';
    document.body.style.top=`-${__lockScrollY}px`;
    document.body.style.width='100%';
    overlay.classList.add('is-open');
    overlay.setAttribute('aria-hidden','false');
  }
  function closePlans(){
    document.body.style.position='';
    document.body.style.top='';
    document.body.style.width='';
    overlay.classList.remove('is-open');
    overlay.setAttribute('aria-hidden','true');
    window.scrollTo(0,__lockScrollY);
  }
  window.showSubscriptionModal=function(e){e.preventDefault();openPlans();return false;};
  if(btnCreate){
    btnCreate.addEventListener('click',function(e){
      const isSubscribed=this.dataset.isSubscribed==='1';
      if(!isSubscribed){
        e.preventDefault();
        const trialEnded=this.dataset.trialEnded==='1';
        const title=document.getElementById('plans-title');
        const subtitle=overlay.querySelector('.plans-subtitle');
        title.textContent=trialEnded?'Tu prueba terminó':'Activa tu plan';
        subtitle.textContent=trialEnded?'Renueva para seguir publicando propiedades.':'Obtén acceso completo para crear y destacar anuncios.';
        openPlans();
      }
    });
  }
  closeBtn?.addEventListener('click',closePlans);
  overlay?.addEventListener('click',(e)=>{if(e.target===overlay)closePlans();});
  document.querySelectorAll('.btn-plan-choose').forEach(btn=>{
    btn.addEventListener('click',async ()=>{
      const plan=btn.dataset.plan;
      try{
        const res=await fetch("{% url 'billing:stripe_create_session' %}",{
          method:"POST",
          credentials:"same-origin",
          headers:{
            "Content-Type":"application/x-www-form-urlencoded",
            "X-CSRFToken":csrftoken,
            "X-Requested-With":"XMLHttpRequest"
          },
          body:new URLSearchParams({plan})
        });
        const data=await res.json();
        if(data.url) window.location=data.url; else alert(data.error||"Error al crear sesión de pago.");
      }catch(err){alert("No se pudo iniciar el pago.");}
    });
  });
})();
</script>
{% endblock %}
