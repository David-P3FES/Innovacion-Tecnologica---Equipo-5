{% extends "base.html" %}
{% load static %}
{% load humanize %}

{% block extra_css %}
<style>
:root { --primary-gradient: linear-gradient(135deg, #9CB28A 0%, #6E889B 100%); }
.header .user-menu .avatar-circle::after {
  font-size: 20px !important;
  transform: translateY(-2px) !important;
  letter-spacing: 0.2px !important;
}

.header .user-menu .avatar-circle {
  display: flex !important;
  align-items: center !important;
  justify-content: center !important;
  position: relative !important;
}
</style>
<link rel="stylesheet" href="{% static 'css/resultados.css' %}?v=5">
{% endblock %}

{% block content %}
<div class="wrap">
  <form class="searchbar clean" method="get" action="{% url 'principal:resultados_busqueda' %}">
    <div class="sb-middle">
      <svg xmlns="http://www.w3.org/2000/svg" class="sb-search" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <circle cx="11" cy="11" r="8"/>
        <line x1="21" y1="21" x2="16.65" y2="16.65"/>
      </svg>
      <input type="text" name="direccion" value="{{ q }}" placeholder="Buscar por dirección, ciudad o colonia">
    </div>

    <button type="submit" class="sb-btn">
      BUSCAR
      <svg xmlns="http://www.w3.org/2000/svg" class="sb-arrow" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <line x1="5" y1="12" x2="19" y2="12"/>
        <polyline points="12 5 19 12 12 19"/>
      </svg>
    </button>
  </form>
</div>

  <div class="layout two-cols">
    <aside class="sidebar pretty" id="sidebar">
      <form method="get" action="{% url 'principal:resultados_busqueda' %}" class="filters v3">
        <input type="hidden" name="direccion" value="{{ q }}">
        <div class="f-header">
          <div class="f-title">Filtros</div>
        </div>

        <div class="f-section f-row2">
          <div>
            <label class="f-label">Operación</label>
            <select class="f-input" name="tipo_operacion">
              <option value="" {% if not tipo_sel %}selected{% endif %}>Todos</option>
              <option value="venta" {% if tipo_sel == "venta" %}selected{% endif %}>Venta</option>
              <option value="renta" {% if tipo_sel == "renta" %}selected{% endif %}>Renta</option>
            </select>
          </div>

          <div>
            <label class="f-label">Financiamiento</label>
            <select class="f-input" name="financiamiento">
              <option value="" {% if not financiamiento %}selected{% endif %}>Cualquiera</option>
              <option value="contado" {% if financiamiento == "contado" %}selected{% endif %}>Contado</option>
              <option value="credito" {% if financiamiento == "credito" %}selected{% endif %}>Crédito</option>
              <option value="ambos" {% if financiamiento == "ambos" %}selected{% endif %}>Crédito o contado</option>
            </select>
          </div>
        </div>

        <div class="f-section">
          <div class="f-subtitle">Precio</div>
          <div class="f-pair">
            <input class="f-input" type="number" name="precio_min" value="{{ precio_min }}" min="0" step="1000" placeholder="Mín.">
            <input class="f-input" type="number" name="precio_max" value="{{ precio_max }}" min="0" step="1000" placeholder="Máx.">
          </div>
        </div>

        <div class="f-section">
          <div class="f-subtitle">Características</div>

          <div class="f-row2">
            <div>
              <label class="f-label">Recámaras</label>
              <input class="f-input" type="number" name="rec_min" value="{{ rec_min }}" min="0" step="1" placeholder="0">
            </div>

            <div>
              <label class="f-label">Baños</label>
              <input class="f-input" type="number" name="banos_min" value="{{ banos_min }}" min="0" step="0.5" placeholder="0">
            </div>
          </div>

          <div class="f-row2">
            <div>
              <label class="f-label">Estacionamientos</label>
              <input class="f-input" type="number" name="est_min" value="{{ est_min }}" min="0" step="1" placeholder="0">
            </div>
            
            <div>
              <label class="f-label">Terreno (m²)</label>
              <input class="f-input" type="number" name="m2t_min" value="{{ m2t_min }}" min="0" step="10" placeholder="0">
            </div>

            <div>
              <label class="f-label"> Construcción (m²)</label>
              <input class="f-input" type="number" name="m2c_min" value="{{ m2c_min }}" min="0" step="10" placeholder="0">
            </div>
          </div>
        </div>


        <div class="f-section">
          <div class="f-subtitle">Ubicación</div>
          <div class="f-row2">
            <input class="f-input" type="text" name="estado" value="{{ estado }}" placeholder="Estado">
            <input class="f-input" type="text" name="ciudad" value="{{ ciudad }}" placeholder="Ciudad">
          </div>
        </div>

        <div class="f-actions">
          <button class="btn-apply" type="submit">Aplicar</button>
          <a class="btn-clear" href="{% url 'principal:resultados_busqueda' %}">Limpiar</a>
        </div>
      </form>
    </aside>

    <main class="results">
      <p class="resume">Se encontraron <strong>{{ total }}</strong> resultados{% if q %} para “{{ q }}”{% endif %}{% if tipo_sel %} en {{ tipo_sel }}{% endif %}.</p>

      {% if page_obj.object_list %}
        <div class="list">
          {% for pub in page_obj.object_list %}
            <article class="card">
              <a class="cover-link" href="{% url 'principal:publicacion_detalle' pub.id %}"></a>

              <div class="thumb">
                {% with portada=pub.foto_portada %}
                  {% if portada %}
                    <img src="{{ portada.imagen.url }}" alt="{{ pub.titulo }}">
                  {% else %}
                    <div class="noimg">Sin foto</div>
                  {% endif %}
                {% endwith %}
                {% if pub.estatus %}
                  <span class="status-badge status-{{ pub.estatus }}">{{ pub.get_estatus_display }}</span>
                {% endif %}
                <button class="like-btn {% if liked_ids and pub.id in liked_ids %}is-liked{% endif %}" type="button" data-pub="{{ pub.id }}"><span class="like-ico">❤</span></button>
              </div>

              <div class="body">
                <div class="row">
                  <h3 class="c-title">{{ pub.titulo }}</h3>
                  <span class="badge">{{ pub.get_tipo_operacion_display }}</span>
                </div>
                <div class="price">${{ pub.precio|floatformat:0|intcomma }}</div>
                <div class="addr">{{ pub.direccion_completa }}</div>

                <div class="card-features">
                  {% if pub.recamaras %}
                    <span class="feat">
                      <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 10h18M4 10V7a3 3 0 013-3h10a3 3 0 013 3v3M6 21v-6a2 2 0 012-2h8a2 2 0 012 2v6M3 21h18"/></svg>
                      <b>{{ pub.recamaras }}</b> hab
                    </span>
                  {% endif %}
                  {% if pub.banos %}
                    <span class="feat">
                      <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M7 10V5a3 3 0 016 0v5M3 14h18M5 14v2a5 5 0 005 5h4a5 5 0 005-5v-2"/></svg>
                      <b>{{ pub.banos }}</b> baños
                    </span>
                  {% endif %}
                  {% if pub.estacionamientos %}
                    <span class="feat">
                      <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 13l2-5h14l2 5M5 13v6m14-6v6M8 19h8"/></svg>
                      <b>{{ pub.estacionamientos }}</b> estac.
                    </span>
                  {% endif %}
                  {% if pub.m2_construccion %}
                    <span class="feat">
                      <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 3h18v18H3z"/><path d="M3 9h18M9 21V9"/></svg>
                      <b>{{ pub.m2_construccion|floatformat:0 }}</b> m² const.
                    </span>
                  {% endif %}
                  {% if pub.m2_terreno %}
                    <span class="feat">
                      <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="7" width="18" height="10" rx="2"/><path d="M7 7v10M17 7v10"/></svg>
                      <b>{{ pub.m2_terreno|floatformat:0 }}</b> m² terreno
                    </span>
                  {% endif %}
                </div>

                <div class="seller">
                  <div class="seller__who">Publicado por: <strong>{% firstof pub.usuario.get_full_name pub.usuario.username %}</strong></div>
                  <div class="seller__actions">
                    {% with email=pub.usuario.email phone=pub.usuario.perfil.whatsapp %}
                      {% if email %}
                        <a class="home-card__action" href="mailto:{{ email }}?subject={{ pub.titulo|urlencode }}" title="Enviar email">
                          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" aria-hidden="true">
                            <path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"></path>
                            <polyline points="22,6 12,13 2,6"></polyline>
                          </svg>
                        </a>
                      {% endif %}

                      {% if phone %}
                        {% if phone|length == 10 %}
                          <a class="home-card__action home-card__action--whatsapp" target="_blank" href="https://wa.me/52{{ phone }}?text={{ pub.titulo|urlencode }}" title="WhatsApp">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor" aria-hidden="true">
                              <path d="M17.472 14.382c-.297-.149-1.758-.867-2.03-.967-.273-.099-.471-.148-.67.15-.197.297-.767.966-.94 1.164-.173.199-.347.223-.644.075-.297-.15-1.255-.463-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.298-.347.446-.52.149-.174.198-.298.298-.497.099-.198.05-.371-.025-.52-.075-.149-.669-1.612-.916-2.207-.242-.579-.487-.5-.669-.51-.173-.008-.371-.01-.57-.01-.198 0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.625.712.227 1.36.195 1.871.118.571-.085 1.758-.719 2.006-1.413.248-.694.248-1.289.173-1.413-.074-.124-.272-.198-.57-.347m-5.421 7.403h-.004a9.87 9.87 0 01-5.031-1.378l-.361-.214-3.741.982.998-3.648-.235-.374a9.86 9.86 0 01-1.51-5.26c.001-5.45 4.436-9.884 9.888-9.884 2.64 0 5.122 1.03 6.988 2.898a9.825 9.825 0 012.893 6.994c-.003 5.45-4.437 9.884-9.885 9.884m8.413-18.297A11.815 11.815 0 0012.05 0C5.495 0 .16 5.335.157 11.892c0 2.096.547 4.142 1.588 5.945L.057 24l6.305-1.654a11.882 11.882 0 005.683 1.448h.005c6.554 0 11.890-5.335 11.893-11.893a11.821 11.821 0 00-3.48-8.413Z"/>
                            </svg>
                          </a>
                        {% else %}
                          <a class="home-card__action home-card__action--whatsapp" target="_blank" href="https://wa.me/{{ phone|cut:'+' }}?text={{ pub.titulo|urlencode }}" title="WhatsApp">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor" aria-hidden="true">
                              <path d="M17.472 14.382c-.297-.149-1.758-.867-2.03-.967-.273-.099-.471-.148-.67.15-.197.297-.767.966-.94 1.164-.173.199-.347.223-.644.075-.297-.15-1.255-.463-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.298-.347.446-.52.149-.174.198-.298.298-.497.099-.198.05-.371-.025-.52-.075-.149-.669-1.612-.916-2.207-.242-.579-.487-.5-.669-.51-.173-.008-.371-.01-.57-.01-.198 0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.625.712.227 1.36.195 1.871.118.571-.085 1.758-.719 2.006-1.413.248-.694.248-1.289.173-1.413-.074-.124-.272-.198-.57-.347m-5.421 7.403h-.004a9.87 9.87 0 01-5.031-1.378l-.361-.214-3.741.982.998-3.648-.235-.374a9.86 9.86 0 01-1.51-5.26c.001-5.45 4.436-9.884 9.888-9.884 2.64 0 5.122 1.03 6.988 2.898a9.825 9.825 0 012.893 6.994c-.003 5.45-4.437 9.884-9.885 9.884m8.413-18.297A11.815 11.815 0 0012.05 0C5.495 0 .16 5.335.157 11.892c0 2.096.547 4.142 1.588 5.945L.057 24l6.305-1.654a11.882 11.882 0 005.683 1.448h.005c6.554 0 11.890-5.335 11.893-11.893a11.821 11.821 0 00-3.48-8.413Z"/>
                            </svg>
                          </a>
                        {% endif %}
                      {% endif %}
                    {% endwith %}
                  </div>
                </div>
              </div>
            </article>
          {% endfor %}
        </div>

        <div class="pager">
          {% if page_obj.has_previous %}
            <a class="p-btn" href="?page={{ page_obj.previous_page_number }}&{{ request.GET.urlencode|cut:'page='|cut:'page=' }}">« Anterior</a>
          {% endif %}
          <span class="p-cur">Página {{ page_obj.number }} de {{ page_obj.paginator.num_pages }}</span>
          {% if page_obj.has_next %}
            <a class="p-btn" href="?page={{ page_obj.next_page_number }}&{{ request.GET.urlencode|cut:'page='|cut:'page=' }}">Siguiente »</a>
          {% endif %}
        </div>
      {% else %}
        <div class="empty"><p>No encontramos resultados.</p></div>
      {% endif %}
    </main>
  </div>

</div>

<script>
window.AUTHENTICATED = "{{ request.user.is_authenticated|yesno:'true,false' }}" === "true";
function getCsrf(){ const m=document.cookie.match(/csrftoken=([^;]+)/); return m?m[1]:''; }
document.addEventListener("click", async (e)=>{
  const btn = e.target.closest(".like-btn"); if(!btn) return;
  const pubId = btn.dataset.pub;
  if(!window.AUTHENTICATED){
    const next = encodeURIComponent(window.location.pathname + window.location.search);
    window.location.href = "{% url 'account_login' %}?next=" + next; return;
  }
  try{
    const r = await fetch("{% url 'principal:toggle_favorito' 0 %}".replace("/0/","/"+pubId+"/"),{method:"POST",headers:{"X-CSRFToken":getCsrf(),"X-Requested-With":"XMLHttpRequest"}});
    const j = await r.json(); if(j.liked){btn.classList.add("is-liked")}else{btn.classList.remove("is-liked")}
  }catch(e){console.error(e)}
});
document.addEventListener('keydown', (e)=>{
  const card = e.target.closest('.card[tabindex="0"]');
  if(!card) return;
  if(e.key === 'Enter' || e.key === ' '){
    e.preventDefault();
    card.querySelector('.cover-link')?.click();
  }
});
</script>
{% endblock %}
