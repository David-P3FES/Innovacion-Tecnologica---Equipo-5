{% extends "base.html" %}
{% load static %}
{% load humanize %}
{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/home.css' %}?v=4">
<link rel="stylesheet" href="{% static 'css/base.css' %}?v=4">
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Plus+Jakarta+Sans:wght@300;400;500;600&display=swap" rel="stylesheet">
{% endblock %}

{% block content %}

<section class="hero">
  <div class="hero__houses">
    <span class="house" style="left:50%; --s:2; --dur:18s; --alpha:.9; animation-delay:-4s;"></span>
  </div>

  <div class="hero__bg"></div>
  <div class="hero__overlay"></div>

  <div class="hero__content">
    <h1 class="hero__title">¬°Encuentra tu nueva casa o renta Ya!</h1>
    <p class="hero__subtitle">Conecta con los mejores vendedores o inmobiliarias de M√©xico.</p>

    <form method="get" action="{% url 'principal:resultados_busqueda' %}" class="searchbar">
      <select name="tipo_operacion" class="searchbar__select" aria-label="Tipo de operaci√≥n">
        <option value="">Tipo</option>
        <option value="venta">Venta</option>
        <option value="renta">Renta</option>
      </select>


      <input
        type="text"
        name="direccion"
        class="searchbar__input"
        placeholder="Buscar por direcci√≥n, ciudad o colonia"
        aria-label="Direcci√≥n, ciudad o colonia"
      />

      <button type="submit" class="searchbar__btn">
        <span class="searchbar__icon" aria-hidden="true"></span>
        Buscar  
      </button>
    </form>
  </div>
</section>


<section class="recientes-wrap">
  <h2>Recientemente publicadas</h2>


  {% if recientes %}
    <div class="grid-recientes">
      {% for pub in recientes %}
        <article class="card">
          <a class="cover-link" href="{% url 'principal:publicacion_detalle' pub.id %}"></a>

          <div class="thumb">
            {% with portada=pub.foto_portada %}
              {% if portada %}
                <img src="{{ portada.imagen.url }}" alt="{{ pub.titulo }}">
              {% else %}
                <div class="noimg">Sin foto</div>
              {% endif %}
            {% endwith %}

            {% if pub.estatus %}
              <span class="status-badge status-{{ pub.estatus }}">{{ pub.get_estatus_display }}</span>
            {% endif %}

            <button
              class="like-btn {% if liked_ids and pub.id in liked_ids %}is-liked{% endif %}"
              type="button"
              data-pub="{{ pub.id }}"
              title="{% if liked_ids and pub.id in liked_ids %}Quitar de favoritos{% else %}Agregar a favoritos{% endif %}">
              <span class="like-ico" aria-hidden="true">‚ù§</span>
            </button>
            <span class="like-count" aria-label="Favoritos">{{ pub.like_count|default:0 }}</span>
          </div>

          <div class="body">
            <div class="row">
              <h3 class="title">{{ pub.titulo }}</h3>
              <span class="badge">{{ pub.get_tipo_operacion_display }}</span>
            </div>
            <div class="price">${{ pub.precio|floatformat:0|intcomma }}</div>
            <div class="addr">{{ pub.direccion_completa }}</div>
            <div class="meta">Hace {{ pub.fecha_creacion|timesince }}</div>

            <div class="seller">
              <div class="seller__who">
                Publicado por:
                <strong>{% firstof pub.usuario.get_full_name pub.usuario.username %}</strong>
              </div>
              <div class="seller__actions">
                {% with email=pub.usuario.email phone=pub.usuario.perfil.whatsapp %}
                  {% if email %}
                    <a class="btn-ico" href="mailto:{{ email }}?subject={{ pub.titulo|urlencode }}">‚úâÔ∏è Email</a>
                  {% endif %}
                  {% if phone %}
                    {% if phone|length == 10 %}
                      <a class="btn-ico" target="_blank" href="https://wa.me/52{{ phone }}?text={{ pub.titulo|urlencode }}">WhatsApp</a>
                    {% else %}
                      <a class="btn-ico" target="_blank" href="https://wa.me/{{ phone|cut:'+' }}?text={{ pub.titulo|urlencode }}">WhatsApp</a>
                    {% endif %}
                  {% endif %}
                {% endwith %}
              </div>
            </div>
          </div>
        </article>
      {% endfor %}
    </div>
  {% else %}
    <div class="empty">
      <div class="empty__icon" aria-hidden="true">üè†</div>
      <div class="empty__text">A√∫n no hay publicaciones recientes.</div>
    </div>
  {% endif %}
</section>

<script>
  (function(){
    const selects = document.querySelectorAll('.searchbar__select');
    selects.forEach(initFancySelect);

    function initFancySelect(sel){
      if (sel.dataset.enhanced) return;
      sel.dataset.enhanced = '1';

      // wrapper visual
      const wrap = document.createElement('div');
      wrap.className = 'selectx';
      sel.parentNode.insertBefore(wrap, sel);
      sel.classList.add('u-hidden-select');
      wrap.appendChild(sel); 
      
      const btn = document.createElement('button');
      btn.type = 'button';
      btn.className = 'selectx__btn';
      btn.setAttribute('aria-haspopup', 'listbox');
      btn.setAttribute('aria-expanded', 'false');

      const label = document.createElement('span');
      label.className = 'selectx__label';
      label.textContent = getLabel(sel);

      const chev = document.createElement('span');
      chev.className = 'selectx__chev';

      btn.appendChild(label);
      btn.appendChild(chev);
      wrap.appendChild(btn);

      // lista
      const list = document.createElement('div');
      list.className = 'selectx__list';
      list.setAttribute('role', 'listbox');
      wrap.appendChild(list);

      // opciones
      Array.from(sel.options).forEach((op, idx) => {
        const item = document.createElement('div');
        item.className = 'selectx__option';
        item.setAttribute('role', 'option');
        item.dataset.value = op.value;
        item.setAttribute('aria-selected', op.selected ? 'true' : 'false');

        const tick = document.createElement('span'); tick.className = 'selectx__tick';
        const text = document.createElement('span'); text.textContent = op.textContent;

        item.appendChild(tick);
        item.appendChild(text);
        list.appendChild(item);

        item.addEventListener('click', () => choose(op.value));
        item.addEventListener('mouseenter', () => focusIndex = idx);
      });

      // estado
      let open = false;
      let focusIndex = sel.selectedIndex >= 0 ? sel.selectedIndex : 0;

      function openList(){
        open = true;
        wrap.classList.add('open');
        btn.setAttribute('aria-expanded', 'true');
        scrollIntoView();
        document.addEventListener('click', onDocClick);
        document.addEventListener('keydown', onKey);
      }
      function closeList(){
        open = false;
        wrap.classList.remove('open');
        btn.setAttribute('aria-expanded', 'false');
        document.removeEventListener('click', onDocClick);
        document.removeEventListener('keydown', onKey);
      }
      function onDocClick(e){
        if (!wrap.contains(e.target)) closeList();
      }
      function onKey(e){
        if (!open && (e.key === 'ArrowDown' || e.key === 'Enter' || e.key === ' ')){
          e.preventDefault(); openList(); return;
        }
        if (!open) return;
        if (e.key === 'Escape'){ closeList(); btn.focus(); }
        else if (e.key === 'ArrowDown'){ e.preventDefault(); move(1); }
        else if (e.key === 'ArrowUp'){ e.preventDefault(); move(-1); }
        else if (e.key === 'Enter' || e.key === ' '){ e.preventDefault(); chooseIndex(focusIndex); }
      }
      function move(delta){
        const opts = list.querySelectorAll('.selectx__option');
        focusIndex = Math.max(0, Math.min(opts.length-1, focusIndex + delta));
        opts[focusIndex].focus?.();
        opts.forEach((o,i)=>o.classList.toggle('is-focus', i===focusIndex));
        scrollIntoView();
      }
      function scrollIntoView(){
        const opts = list.querySelectorAll('.selectx__option');
        const el = opts[focusIndex]; if (!el) return;
        const {top,bottom} = el.getBoundingClientRect();
        const {top:lt,bottom:lb} = list.getBoundingClientRect();
        if (top < lt) list.scrollTop -= (lt - top + 6);
        if (bottom > lb) list.scrollTop += (bottom - lb + 6);
      }
      function choose(value){
        sel.value = value; sel.dispatchEvent(new Event('change', {bubbles:true}));
        label.textContent = getLabel(sel);
        list.querySelectorAll('.selectx__option').forEach(o=>{
          o.setAttribute('aria-selected', o.dataset.value === value ? 'true' : 'false');
        });
        closeList(); btn.focus();
      }
      function chooseIndex(i){
        const opt = sel.options[i]; if (opt) choose(opt.value);
      }
      function getLabel(s){
        const op = s.options[s.selectedIndex];
        return op ? op.textContent : (s.options[0]?.textContent || 'Selecciona');
      }

      btn.addEventListener('click', ()=> open ? closeList() : openList());

      // sincroniza si cambian el select nativo por c√≥digo
      sel.addEventListener('change', ()=>{
        label.textContent = getLabel(sel);
        list.querySelectorAll('.selectx__option').forEach(o=>{
          o.setAttribute('aria-selected', o.dataset.value === sel.value ? 'true' : 'false');
        });
      });
    }
  })();
  window.AUTHENTICATED = "{{ user.is_authenticated|yesno:'true,false' }}" === "true";
  function getCsrf(){ const m=document.cookie.match(/csrftoken=([^;]+)/); return m?m[1]:''; }

  document.addEventListener("click", async (e)=>{
    const btn = e.target.closest(".like-btn");
    if(!btn) return;

    const pubId = btn.dataset.pub;

    if(!window.AUTHENTICATED){
      const next = encodeURIComponent(window.location.pathname + window.location.search);
      window.location.href = "{% url 'account_login' %}?next=" + next;
      return;
    }

    try{
      const r = await fetch("{% url 'principal:toggle_favorito' 0 %}".replace("/0/","/"+pubId+"/"), {
        method:"POST",
        headers:{ "X-CSRFToken": getCsrf(), "X-Requested-With":"XMLHttpRequest" }
      });
      const j = await r.json();
      if(j.liked){
        btn.classList.add("is-liked");
        const c = btn.nextElementSibling; if(c && c.classList.contains("like-count")) c.textContent = (+c.textContent||0)+1;
      }else{
        btn.classList.remove("is-liked");
        const c = btn.nextElementSibling; if(c && c.classList.contains("like-count")) c.textContent = Math.max(0,(+c.textContent||0)-1);
      }
    }catch(err){
      console.error(err);
      alert("No se pudo actualizar tu favorito. Int√©ntalo de nuevo.");
    }
  });

document.addEventListener('DOMContentLoaded', () => {
  const hero = document.querySelector('.hero');
  if (!hero) return;

  const layer = document.createElement('div');
  layer.className = 'hero__houses';
  hero.appendChild(layer);

  const houses = 12;
  for (let i = 0; i < houses; i++) {
    const el = document.createElement('span');
    el.className = 'house';

    const left   = (4 + Math.random() * 92).toFixed(2); 
    const dur    = (12 + Math.random() * 12).toFixed(2);
    const delay  = (-Math.random() * dur).toFixed(2);
    const scale  = (1.0 + Math.random() * 1.4).toFixed(2); 
    const alpha  = (0.55 + Math.random() * 0.35).toFixed(2); 


    el.style.left = left + '%';
    el.style.setProperty('--dur', dur + 's');
    el.style.setProperty('--s', scale);
    el.style.setProperty('--alpha', alpha);
    el.style.animationDelay = delay + 's';

    layer.appendChild(el);
  }

  const sparkles = 28;
  for (let i = 0; i < sparkles; i++) {
    const sp = document.createElement('span');
    sp.className = 'sparkle';

    const left   = (Math.random() * 100).toFixed(2);
    const dur    = (14 + Math.random() * 14).toFixed(2);
    const delay  = (-Math.random() * dur).toFixed(2);
    const size   = (3 + Math.random() * 6).toFixed(0);
    const tint   = (45 + Math.random() * 20).toFixed(0);
    sp.style.left = left + '%';
    sp.style.width = size + 'px';
    sp.style.height = size + 'px';
    sp.style.setProperty('--dur', dur + 's');
    sp.style.animationDelay = delay + 's';
    sp.style.background = `hsl(150 ${tint}% 62% / .55)`;
    sp.style.boxShadow = `0 0 10px hsl(150 ${tint}% 60% / .65)`;

    layer.appendChild(sp);
  }
});

(function(){
  const selects = document.querySelectorAll('.searchbar__select');
  selects.forEach(initFancySelect);

  function initFancySelect(sel){
    if (sel.dataset.enhanced) return;
    sel.dataset.enhanced = '1';

    // wrapper visual
    const wrap = document.createElement('div');
    wrap.className = 'selectx';
    sel.parentNode.insertBefore(wrap, sel);
    sel.classList.add('u-hidden-select');
    wrap.appendChild(sel); // dejamos el <select> dentro pero oculto

    // bot√≥n visible
    const btn = document.createElement('button');
    btn.type = 'button';
    btn.className = 'selectx__btn';
    btn.setAttribute('aria-haspopup', 'listbox');
    btn.setAttribute('aria-expanded', 'false');

    const label = document.createElement('span');
    label.className = 'selectx__label';
    label.textContent = getLabel(sel);

    const chev = document.createElement('span');
    chev.className = 'selectx__chev';

    btn.appendChild(label);
    btn.appendChild(chev);
    wrap.appendChild(btn);

    // lista
    const list = document.createElement('div');
    list.className = 'selectx__list';
    list.setAttribute('role', 'listbox');
    wrap.appendChild(list);

    // opciones
    Array.from(sel.options).forEach((op, idx) => {
      const item = document.createElement('div');
      item.className = 'selectx__option';
      item.setAttribute('role', 'option');
      item.dataset.value = op.value;
      item.setAttribute('aria-selected', op.selected ? 'true' : 'false');

      const tick = document.createElement('span'); tick.className = 'selectx__tick';
      const text = document.createElement('span'); text.textContent = op.textContent;

      item.appendChild(tick);
      item.appendChild(text);
      list.appendChild(item);

      item.addEventListener('click', () => choose(op.value));
      item.addEventListener('mouseenter', () => focusIndex = idx);
    });

    // estado
    let open = false;
    let focusIndex = sel.selectedIndex >= 0 ? sel.selectedIndex : 0;

    function openList(){
      open = true;
      wrap.classList.add('open');
      btn.setAttribute('aria-expanded', 'true');
      scrollIntoView();
      document.addEventListener('click', onDocClick);
      document.addEventListener('keydown', onKey);
    }
    function closeList(){
      open = false;
      wrap.classList.remove('open');
      btn.setAttribute('aria-expanded', 'false');
      document.removeEventListener('click', onDocClick);
      document.removeEventListener('keydown', onKey);
    }
    function onDocClick(e){
      if (!wrap.contains(e.target)) closeList();
    }
    function onKey(e){
      if (!open && (e.key === 'ArrowDown' || e.key === 'Enter' || e.key === ' ')){
        e.preventDefault(); openList(); return;
      }
      if (!open) return;
      if (e.key === 'Escape'){ closeList(); btn.focus(); }
      else if (e.key === 'ArrowDown'){ e.preventDefault(); move(1); }
      else if (e.key === 'ArrowUp'){ e.preventDefault(); move(-1); }
      else if (e.key === 'Enter' || e.key === ' '){ e.preventDefault(); chooseIndex(focusIndex); }
    }
    function move(delta){
      const opts = list.querySelectorAll('.selectx__option');
      focusIndex = Math.max(0, Math.min(opts.length-1, focusIndex + delta));
      opts[focusIndex].focus?.();
      opts.forEach((o,i)=>o.classList.toggle('is-focus', i===focusIndex));
      scrollIntoView();
    }
    function scrollIntoView(){
      const opts = list.querySelectorAll('.selectx__option');
      const el = opts[focusIndex]; if (!el) return;
      const {top,bottom} = el.getBoundingClientRect();
      const {top:lt,bottom:lb} = list.getBoundingClientRect();
      if (top < lt) list.scrollTop -= (lt - top + 6);
      if (bottom > lb) list.scrollTop += (bottom - lb + 6);
    }
    function choose(value){
      sel.value = value; sel.dispatchEvent(new Event('change', {bubbles:true}));
      label.textContent = getLabel(sel);
      list.querySelectorAll('.selectx__option').forEach(o=>{
        o.setAttribute('aria-selected', o.dataset.value === value ? 'true' : 'false');
      });
      closeList(); btn.focus();
    }
    function chooseIndex(i){
      const opt = sel.options[i]; if (opt) choose(opt.value);
    }
    function getLabel(s){
      const op = s.options[s.selectedIndex];
      return op ? op.textContent : (s.options[0]?.textContent || 'Selecciona');
    }

    // eventos bot√≥n
    btn.addEventListener('click', ()=> open ? closeList() : openList());

    // sincroniza si cambian el select nativo por c√≥digo
    sel.addEventListener('change', ()=>{
      label.textContent = getLabel(sel);
      list.querySelectorAll('.selectx__option').forEach(o=>{
        o.setAttribute('aria-selected', o.dataset.value === sel.value ? 'true' : 'false');
      });
    });
  }
})();
</script>
{% endblock %}
