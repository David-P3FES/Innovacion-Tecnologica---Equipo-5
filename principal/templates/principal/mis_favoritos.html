{% extends "base.html" %}
{% load static %}
{% load humanize %}

{% block extra_css %}
<style>
:root { --primary-gradient: linear-gradient(135deg, #9CB28A 0%, #6E889B 100%); }
.header .user-menu .avatar-circle::after {
  font-size: 20px !important;
  transform: translateY(-2px) !important;
  letter-spacing: 0.2px !important;
}

.header .user-menu .avatar-circle {
  display: flex !important;
  align-items: center !important;
  justify-content: center !important;
  position: relative !important;
}
</style>
<link rel="stylesheet" href="{% static 'css/favoritos.css' %}?v=20251106a">
{% endblock %}

{% block content %}
<div class="favoritos-page">
  <div class="fav-wrap">
    <h1 class="title">Mis favoritos</h1>
    <p class="resume">Tienes <strong>{{ publicaciones|length }}</strong> favoritos.</p>

    {% if publicaciones %}
      <div class="home-grid">
        {% for pub in publicaciones %}
          <article class="home-card">
            <a class="home-card__link" href="{% url 'principal:publicacion_detalle' pub.id %}"></a>

            <div class="home-card__image">
              {% with portada=pub.foto_portada %}
                {% if portada %}
                  <img src="{{ portada.imagen.url }}" alt="{{ pub.titulo }}">
                {% else %}
                  <div class="home-card__noimage">Sin foto</div>
                {% endif %}
              {% endwith %}

              {% if pub.estatus %}
                <span class="status-badge status-{{ pub.estatus }}">{{ pub.get_estatus_display }}</span>
              {% endif %}

              <button
                class="like-btn {% if liked_ids and pub.id in liked_ids %}is-liked{% endif %}"
                type="button"
                data-pub="{{ pub.id }}"
                title="{% if liked_ids and pub.id in liked_ids %}Quitar de favoritos{% else %}Agregar a favoritos{% endif %}">
                <span class="like-ico">❤</span>
              </button>
            </div>

            <div class="pub-body">
              <h3 class="pub-title">{{ pub.titulo }}</h3>
              <div class="pub-price">${{ pub.precio|floatformat:0|intcomma }}</div>

              <div class="pub-location">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor"><path d="M12 2C8.13 2 5 5.13 5 9c0 5.25 7 13 7 13s7-7.75 7-13c0-3.87-3.13-7-7-7zm0 9.5a2.5 2.5 0 110-5 2.5 2.5 0 010 5z"/></svg>
                {{ pub.direccion_completa }}
              </div>

              <div class="pub-features">
                {% if pub.recamaras %}
                  <span class="feat">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                      <path d="M3 10h18M4 10V7a3 3 0 013-3h10a3 3 0 013 3v3M6 21v-6a2 2 0 012-2h8a2 2 0 012 2v6M3 21h18"/>
                    </svg>
                    {{ pub.recamaras }} hab
                  </span>
                {% endif %}

                {% if pub.banos %}
                  <span class="feat">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                      <path d="M7 10V5a3 3 0 016 0v5M3 14h18M5 14v2a5 5 0 005 5h4a5 5 0 005-5v-2"/>
                    </svg>
                    {{ pub.banos }} baños
                  </span>
                {% endif %}

                {% if pub.estacionamientos %}
                  <span class="feat">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                      <path d="M3 13l2-5h14l2 5M5 13v6m14-6v6M8 19h8"/>
                    </svg>
                    {{ pub.estacionamientos }} estac.
                  </span>
                {% endif %}

                {% if pub.m2_construccion %}
                  <span class="feat">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                      <path d="M3 3h18v18H3z"/><path d="M3 9h18M9 21V9"/>
                    </svg>
                    {{ pub.m2_construccion|floatformat:0 }} m² const.
                  </span>
                {% endif %}

                {% if pub.m2_terreno %}
                  <span class="feat">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                      <rect x="3" y="7" width="18" height="10" rx="2"/><path d="M7 7v10M17 7v10"/>
                    </svg>
                    {{ pub.m2_terreno|floatformat:0 }} m² terreno
                  </span>
                {% endif %}
              </div>
            </div>
          </article>
        {% endfor %}
      </div>
    {% else %}
      <div class="empty">
        <p>No tienes favoritos aún.</p>
        <p>Desde el Home o Resultados, toca el ❤ para guardar publicaciones.</p>
      </div>
    {% endif %}
  </div>
</div>

<script>
  window.AUTHENTICATED = "{{ request.user.is_authenticated|yesno:'true,false' }}" === "true";
  function getCsrf(){ const m=document.cookie.match(/csrftoken=([^;]+)/); return m?m[1]:''; }
  document.addEventListener("click", async (e)=>{
    const btn = e.target.closest(".like-btn");
    if(!btn) return;
    const pubId = btn.dataset.pub;

    if(!window.AUTHENTICATED){
      const next = encodeURIComponent(window.location.pathname + window.location.search);
      window.location.href = "{% url 'account_login' %}?next=" + next;
      return;
    }

    try{
      const r = await fetch("{% url 'principal:toggle_favorito' 0 %}".replace("/0/","/"+pubId+"/"), {
        method:"POST",
        headers:{ "X-CSRFToken": getCsrf(), "X-Requested-With":"XMLHttpRequest" }
      });
      const j = await r.json();
      if(j.liked){
        btn.classList.add("is-liked");
      }else{
        btn.classList.remove("is-liked");
      }
    }catch(err){
      alert("No se pudo actualizar tu favorito. Inténtalo de nuevo.");
    }
  });
</script>
{% endblock %}
