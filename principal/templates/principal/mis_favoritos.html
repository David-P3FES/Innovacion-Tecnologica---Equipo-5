{% extends "base.html" %}
{% load humanize %}

{% block content %}
<div class="wrap">
  <h1 class="title">Mis favoritos</h1>
  <p class="resume">Tienes <strong>{{ publicaciones|length }}</strong> favoritos.</p>

  {% if publicaciones %}
    <div class="grid">
      {% for pub in publicaciones %}
        <article class="card">
          <div class="thumb">
            {% with portada=pub.foto_portada %}
              {% if portada %}
                <img src="{{ portada.imagen.url }}" alt="{{ pub.titulo }}">
              {% else %}
                <div class="noimg">Sin foto</div>
              {% endif %}
            {% endwith %}

            <!-- SIEMPRE mostrar el estatus -->
            <span class="status-badge status-{{ pub.estatus }}">
              {{ pub.get_estatus_display }}
            </span>

            <!-- Corazón + contador -->
            <button
              class="like-btn {% if liked_ids and pub.id in liked_ids %}is-liked{% endif %}"
              type="button"
              data-pub="{{ pub.id }}"
              title="{% if liked_ids and pub.id in liked_ids %}Quitar de favoritos{% else %}Agregar a favoritos{% endif %}">
              <span class="like-ico">❤</span>
            </button>
            <span class="like-count">{{ pub.like_count|default:0 }}</span>
          </div>

          <div class="body">
            <div class="row">
              <h3 class="c-title">{{ pub.titulo }}</h3>
              <span class="badge">{{ pub.get_tipo_operacion_display }}</span>
            </div>
            <div class="price">${{ pub.precio|floatformat:0|intcomma }}</div>
            <div class="addr">{{ pub.direccion_completa }}</div>
          </div>
        </article>
      {% endfor %}
    </div>
  {% else %}
    <div class="empty">
      <p>No tienes favoritos aún.</p>
      <p>Desde el Home o Resultados, toca el ❤ para guardar publicaciones.</p>
    </div>
  {% endif %}
</div>

<style>
.wrap{max-width:1240px;margin:1rem auto;padding:0 1rem;}
.title{margin:0 0 .5rem;}
.resume{color:#666;margin:.15rem 0 .75rem;}
.grid{display:grid;grid-template-columns:repeat(2,1fr);gap:1rem;}
@media (max-width:980px){.grid{grid-template-columns:1fr}}
.card{border:1px solid #eee;border-radius:12px;overflow:hidden;background:#fff;}
.thumb{position:relative;height:180px;background:#f5f5f5;display:flex;align-items:center;justify-content:center;}
.thumb img{width:100%;height:100%;object-fit:cover;}
.noimg{color:#777;}
.body{padding:.8rem;display:flex;flex-direction:column;gap:.35rem;}
.row{display:flex;justify-content:space-between;align-items:center;gap:.5rem;}
.c-title{margin:0;font-size:1.05rem;}
.badge{background:#eef;padding:.15rem .4rem;border-radius:.4rem;font-size:.8rem;}
.price{font-weight:800;}
.addr{color:#444;}

/* —— Corazón + contador —— */
.like-btn{position:absolute;top:10px;right:10px;display:inline-flex;align-items:center;justify-content:center;width:36px;height:36px;border-radius:999px;border:1px solid #e8e8e8;background:rgba(255,255,255,.9);cursor:pointer;box-shadow:0 6px 16px rgba(0,0,0,.12);}
.like-btn .like-ico{font-size:18px;line-height:1;color:#888;}
.like-btn.is-liked{background:#ffe9ed;border-color:#ffc6d0;}
.like-btn.is-liked .like-ico{color:#e25563;}
.like-count{position:absolute;top:10px;right:52px;font-size:.9rem;color:#333;background:#fff;border:1px solid #eee;border-radius:999px;padding:.1rem .45rem;}

/* —— Pastillas de estatus (siempre visibles) —— */
.status-badge{position:absolute;left:10px;top:10px;font-size:.78rem;color:#fff;border-radius:8px;padding:.15rem .45rem;text-transform:capitalize;box-shadow:0 8px 20px rgba(0,0,0,.12);}
.status-disponible{background:#16a34a;} /* verde */
.status-en_trato{background:#f59e0b;}   /* ámbar */
.status-cerrada{background:#6b7280;}    /* gris */
</style>

<script>
  // Reutiliza el mismo JS de like que en home/resultados
  window.AUTHENTICATED = "{{ request.user.is_authenticated|yesno:'true,false' }}" === "true";
  function getCsrf(){ const m=document.cookie.match(/csrftoken=([^;]+)/); return m?m[1]:''; }
  document.addEventListener("click", async (e)=>{
    const btn = e.target.closest(".like-btn");
    if(!btn) return;
    const pubId = btn.dataset.pub;

    if(!window.AUTHENTICATED){
      const next = encodeURIComponent(window.location.pathname + window.location.search);
      window.location.href = "{% url 'account_login' %}?next=" + next;
      return;
    }

    try{
      const r = await fetch("{% url 'principal:toggle_favorito' 0 %}".replace("/0/","/"+pubId+"/"), {
        method:"POST",
        headers:{ "X-CSRFToken": getCsrf(), "X-Requested-With":"XMLHttpRequest" }
      });
      const j = await r.json();
      if(j.liked){
        btn.classList.add("is-liked");
        const c = btn.nextElementSibling; if(c && c.classList.contains("like-count")) c.textContent = (+c.textContent||0)+1;
      }else{
        btn.classList.remove("is-liked");
        const c = btn.nextElementSibling; if(c && c.classList.contains("like-count")) c.textContent = Math.max(0,(+c.textContent||0)-1);
      }
    }catch(err){
      console.error(err);
      alert("No se pudo actualizar tu favorito. Inténtalo de nuevo.");
    }
  });
</script>
{% endblock %}
